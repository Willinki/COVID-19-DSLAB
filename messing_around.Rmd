---
title: "Analisi sulla serie storica dei decessi in lombardia"
output: html_notebook
---

Prima di tutto importo il file relativo ai decessi in Lombardia e lo trasformo in serie temporale, inoltre importo le librerie necessarie alla gestione.
```{r}
if(!require(tidyverse)) install.packages("tidyverse")
if(!require(xts)) install.packages("xts")
if(!require(zoo)) install.packages("zoo")
if(!require(lubridate)) install.packages("lubridate")
if(!require(forecast)) install.packages("forecast")
if(!require(tseries)) install.packages("tseries")
define_ts <- function(df){
  as.xts(df$DECESSI_P10k, order.by = df$DATA) %>% first('4 months')
}
define_ts_w <- function(df){
  as.xts(df$DECESSI_P10k_mean, order.by = as.Date(db_w$WEEK)) %>% first('5 months')
}
plot_list <- function(list_of_df) {
  list_of_df %>% lapply(
    function(ts) ggplot(ts, aes(x = time(ts), y = ts, color = year(time(ts)))) + geom_line() + geom_point()
  )
}

db <- read_csv("data/lombardia_giorno_totale.csv")
db_w <- db %>% group_by(WEEK = cut(DATA, "weeks")) %>% 
  summarise(DECESSI_P10k_mean = mean(DECESSI_P10k)) 
db_m <- db %>% group_by(MONTH = cut(DATA, "month")) %>% 
  summarise(DECESSI_P10k_mean = mean(DECESSI_P10k)) 

decessi_d <- as.xts(db$DECESSI_P10k, order.by = db$DATA) %>% na.approx()
decessi_w <- as.xts(db_w$DECESSI_P10k_mean, order.by = as.Date(db_w$WEEK)) #%>% na.approx()
decessi_m <- as.xts(db_m$DECESSI_P10k_mean, order.by = as.Date(db_m$MONTH)) #%>% na.approx()

decessi_d_list <- db  %>% 
  group_by(year(DATA)) %>% as.data.frame() %>%
  select(DECESSI_P10k, DATA) %>% 
  group_split() %>% lapply(define_ts)

decessi_w_list <- db_w  %>% 
  group_by(year(WEEK)) %>% as.data.frame() %>%
  select(DECESSI_P10k_mean, WEEK) %>% 
```

Prima suddivido il dataset in training e test set.
```{r}
train <- decessi_w["2015/2018"]
test <- decessi_w["2019"]
```

Si osserva che i dati non possiedono un trend evidente, almeno per quanto riguarda i dati.

Possiamo provare con un primo modello naive, da usare come benchmark.

Questo Ã¨ un primo modo per renderla stazionaria.
```{r}
model <- auto.arima(decessi_d)
delta <- xts(as.numeric(decessi_d) - fitted(model), order.by = time(decessi_d))
delta %>% autoplot()

adf.test(delta)
acf(delta)
```

```{r}
diff(decessi_d) %>% plot()
acf(decessi_d)
na.approx(decessi_d) %>% diff()

```

